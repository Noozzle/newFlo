{% extends "base.html" %}

{% block title %}{{ month_data.month_name }} {{ month_data.year }} - FloTrader{% endblock %}

{% block content %}
<!-- Account Balance -->
<div class="account-banner">
    <div class="account-info">
        <span class="label">Account Balance:</span>
        <span class="value" id="account-balance">${{ "%.2f"|format(balance) }}</span>
    </div>
    {% if open_positions %}
    <div class="account-info">
        <span class="label">Unrealized P&L:</span>
        <span class="value {% if total_unrealized >= 0 %}positive{% else %}negative{% endif %}" id="total-unrealized">
            {% if total_unrealized >= 0 %}+{% endif %}${{ "%.4f"|format(total_unrealized) }}
            <span class="pct">({{ "%.2f"|format(total_unrealized_pct) }}%)</span>
        </span>
    </div>
    {% endif %}
    <span class="badge live" id="ws-status">CONNECTING...</span>
</div>

<!-- Open Positions Banner -->
{% if open_positions %}
<div class="open-positions-banner">
    <div class="banner-header">
        <h3>Open Positions ({{ open_positions|length }})</h3>
    </div>
    <div class="positions-grid" id="positions-grid">
        {% for item in open_positions %}
        <div class="position-card" data-symbol="{{ item.position.symbol }}">
            <div class="position-symbol">{{ item.position.symbol }}</div>
            <div class="position-side {% if item.position.side == 'Buy' %}buy{% else %}sell{% endif %}">{% if item.position.side == 'Buy' %}LONG{% else %}SHORT{% endif %}</div>
            <div class="position-details">
                <span>Size: {{ item.position.size }}</span>
                <span>Entry: ${{ "%.4f"|format(item.position.entry_price) }}</span>
            </div>
            <div class="position-pnl {% if item.position.unrealized_pnl >= 0 %}positive{% else %}negative{% endif %}">
                {% if item.position.unrealized_pnl >= 0 %}+{% endif %}${{ "%.4f"|format(item.position.unrealized_pnl) }}
            </div>
            <div class="position-pct {% if item.pnl_pct >= 0 %}positive{% else %}negative{% endif %}">
                {% if item.pnl_pct >= 0 %}+{% endif %}{{ "%.2f"|format(item.pnl_pct) }}%
            </div>
            <div class="position-price">
                Mark: <span class="mark-price">${{ "%.4f"|format(item.position.mark_price) }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% else %}
<div class="open-positions-banner empty">
    <div class="banner-header">
        <h3>No Open Positions</h3>
    </div>
    <div class="positions-grid" id="positions-grid"></div>
</div>
{% endif %}

<div class="calendar-container">
    <!-- Header with navigation -->
    <div class="calendar-header">
        <a href="/?year={{ prev_year }}&month={{ prev_month }}&tz={{ tz }}" class="nav-btn">&larr; Prev</a>
        <h2>{{ month_data.month_name }} {{ month_data.year }} <span class="tz-label">({{ 'UTC' if use_utc else 'Local' }})</span></h2>
        <a href="/?year={{ next_year }}&month={{ next_month }}&tz={{ tz }}" class="nav-btn">Next &rarr;</a>
    </div>

    <!-- Month summary -->
    <div class="calendar-summary">
        <div class="summary-item">
            <span class="label">Realized P&L</span>
            <span class="value {% if month_data.month_pnl > 0 %}positive{% elif month_data.month_pnl < 0 %}negative{% endif %}">
                {% if month_data.month_pnl >= 0 %}+{% endif %}${{ "%.2f"|format(month_data.month_pnl) }}
            </span>
        </div>
        <div class="summary-item">
            <span class="label">Total Trades</span>
            <span class="value">{{ month_data.month_trades }}</span>
        </div>
    </div>

    <!-- Weekday headers -->
    <div class="calendar-grid">
        <div class="weekday">Mon</div>
        <div class="weekday">Tue</div>
        <div class="weekday">Wed</div>
        <div class="weekday">Thu</div>
        <div class="weekday">Fri</div>
        <div class="weekday">Sat</div>
        <div class="weekday">Sun</div>

        <!-- Calendar days -->
        {% for day in calendar_days %}
        <div class="{{ day.css_class }}" {% if day.number %}onclick="window.location='/day/{{ day.date_str }}?tz={{ tz }}'"{% endif %}>
            {% if day.number %}
            <span class="day-number">{{ day.number }}</span>
            {% if day.stats %}
            <span class="trade-count">{{ day.stats.trade_count }} trade{% if day.stats.trade_count != 1 %}s{% endif %}</span>
            <span class="pnl {% if day.stats.total_pnl > 0 %}positive{% else %}negative{% endif %}">
                {% if day.stats.total_pnl >= 0 %}+{% endif %}${{ "%.2f"|format(day.stats.total_pnl) }}
            </span>
            {% endif %}
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <!-- Legend -->
    <div class="legend">
        <div class="legend-item">
            <span class="legend-color profitable"></span>
            <span>Profitable Day</span>
        </div>
        <div class="legend-item">
            <span class="legend-color losing"></span>
            <span>Losing Day</span>
        </div>
        <div class="legend-item">
            <span class="legend-color today-indicator"></span>
            <span>Today</span>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/calendar.js"></script>
<script>
// WebSocket for realtime updates
const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
const wsUrl = `${wsProtocol}//${window.location.host}/ws/positions`;
let ws = null;
let reconnectInterval = null;

function connectWebSocket() {
    ws = new WebSocket(wsUrl);

    ws.onopen = () => {
        console.log('WebSocket connected');
        document.getElementById('ws-status').textContent = 'LIVE';
        document.getElementById('ws-status').classList.add('connected');
        if (reconnectInterval) {
            clearInterval(reconnectInterval);
            reconnectInterval = null;
        }
    };

    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        updateDisplay(data);
    };

    ws.onclose = () => {
        console.log('WebSocket disconnected');
        document.getElementById('ws-status').textContent = 'DISCONNECTED';
        document.getElementById('ws-status').classList.remove('connected');
        if (!reconnectInterval) {
            reconnectInterval = setInterval(connectWebSocket, 3000);
        }
    };

    ws.onerror = (error) => {
        console.error('WebSocket error:', error);
    };
}

function updateDisplay(data) {
    // Update balance
    const balanceEl = document.getElementById('account-balance');
    if (balanceEl && data.balance) {
        balanceEl.textContent = '$' + parseFloat(data.balance.total_equity).toFixed(2);
    }

    // Update positions
    const grid = document.getElementById('positions-grid');
    const unrealizedEl = document.getElementById('total-unrealized');

    if (data.positions && data.positions.length > 0) {
        let totalUnrealized = 0;
        let totalUnrealizedPct = 0;

        data.positions.forEach(pos => {
            const pnl = parseFloat(pos.unrealized_pnl);
            const pnlPct = parseFloat(pos.pnl_pct);
            totalUnrealized += pnl;
            totalUnrealizedPct += pnlPct;

            let card = grid.querySelector(`.position-card[data-symbol="${pos.symbol}"]`);

            if (!card) {
                // Create new card
                card = document.createElement('div');
                card.className = 'position-card';
                card.dataset.symbol = pos.symbol;
                grid.appendChild(card);
            }

            card.innerHTML = `
                <div class="position-symbol">${pos.symbol}</div>
                <div class="position-side ${pos.side === 'Buy' ? 'buy' : 'sell'}">${pos.side === 'Buy' ? 'LONG' : 'SHORT'}</div>
                <div class="position-details">
                    <span>Size: ${pos.size}</span>
                    <span>Entry: $${parseFloat(pos.entry_price).toFixed(4)}</span>
                </div>
                <div class="position-pnl ${pnl >= 0 ? 'positive' : 'negative'}">
                    ${pnl >= 0 ? '+' : ''}$${pnl.toFixed(4)}
                </div>
                <div class="position-pct ${pnlPct >= 0 ? 'positive' : 'negative'}">
                    ${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(2)}%
                </div>
                <div class="position-price">
                    Mark: <span class="mark-price">$${parseFloat(pos.mark_price).toFixed(4)}</span>
                </div>
            `;
        });

        // Update total
        if (unrealizedEl) {
            unrealizedEl.innerHTML = `
                ${totalUnrealized >= 0 ? '+' : ''}$${totalUnrealized.toFixed(4)}
                <span class="pct">(${totalUnrealizedPct >= 0 ? '+' : ''}${totalUnrealizedPct.toFixed(2)}%)</span>
            `;
            unrealizedEl.className = 'value ' + (totalUnrealized >= 0 ? 'positive' : 'negative');
        }

        // Remove closed positions
        const currentSymbols = data.positions.map(p => p.symbol);
        grid.querySelectorAll('.position-card').forEach(card => {
            if (!currentSymbols.includes(card.dataset.symbol)) {
                card.remove();
            }
        });

        // Update banner title
        const banner = document.querySelector('.open-positions-banner');
        if (banner) {
            banner.classList.remove('empty');
            const title = banner.querySelector('h3');
            if (title) title.textContent = `Open Positions (${data.positions.length})`;
        }
    } else {
        // No positions
        grid.innerHTML = '';
        if (unrealizedEl) {
            unrealizedEl.innerHTML = '$0.0000 <span class="pct">(0.00%)</span>';
            unrealizedEl.className = 'value';
        }
        const banner = document.querySelector('.open-positions-banner');
        if (banner) {
            banner.classList.add('empty');
            const title = banner.querySelector('h3');
            if (title) title.textContent = 'No Open Positions';
        }
    }
}

// Connect on page load
connectWebSocket();
</script>
{% endblock %}
